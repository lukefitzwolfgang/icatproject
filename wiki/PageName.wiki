#summary Installation instructions for ICAT 4.1

<wiki:toc max_depth="3" />

= Installation instructions for ICAT 4.1 =

== Source of pre-requisite materials ==

Java Enterprise Edition, Glassfish Server, Oracle Database Express, the Oracle client tools (sqlplus), Oracle Java connector (ojdbc14.jar) are all available for download from Oracle.   The versions required are the following:

 * Java Enterprise Edition - 6 or newer;
 * Glassfish Server - 3.1 or newer;
 * Oracle Express - 10 or newer;
 * Oracle Client tools - 10 or newer.

== Source of installation materials ==

ICAT 4.1 is available for download from the following URL:  
{{{
http://icatproject.googlecode.com/files/icat4.0.0.zip 
}}}

For example, you can download with the wget command as follows:
{{{
wget http://icatproject.googlecode.com/files/icat4.0.0.zip 
}}}

If you would like a version from the SVN, then it can be obtained with a command as follows:
{{{
svn checkout https://icatproject.googlecode.com/svn/ops/icat40 
}}}

If you would like to review the set of downloads available, use the following URL in a browser:
{{{
http://code.google.com/p/icatproject/downloads/list
}}}

The release zip contains a file called readme.txt with instructions.  A longer version is available at the following URL:
{{{
http://code.google.com/p/icatproject/wiki/InstallIcat40 
}}}

If you wish to browse the materials on the web site, use the following link:
{{{
http://code.google.com/p/icatproject/source/browse/ops/icat40/
}}}

== Assumptions ==

In order to make it simple to install ICAT40, the following configuration is assumed:

Operating system: 
 * operation system: Linux
 * username: glassfish3
 * home directory: /home/glassfish3
 * shell: bash

Environmental variables:
It is conventional to set the following variables:
 * JAVA_HOME;
 * ORACLE_HOME;
 * ORACLE_SID;
 * GLASSFISH_HOME;
 * PATH - add $JAVA_HOME/bin, ORACLE_HOME/bin and GLASSFISH_HOME/bin. 

Note that the operating system user glassfish3 is running the Glassfish Server and the applications.  There is no need to have enhanced privileges to install ICAT once the prerequisite software has been installed and the user account glassfish3 has been created. You do not require access as system administrator of the database once the user accounts icat and icatuser have been created.

Glassfish Server:
 * directory: /home/glassfish3/glassfish3/glassfish
 * admin user: admin
 * admin user password: adminadmin
 * master password: changeit
 * asadmin command: The operating system user called glassfish3 has asadmin on the PATH 
 * ojdbc14.jar: The file ojdbc14.jar has been added to /home/glassfish3/glassfish3/glassfish/domains/domain1/lib
 * icat.properties: The file icat.properties has been added to /home/glassfish3/glassfish3/glassfish/domains/domain1/config

Oracle database:

If using Oracle Express on localhost, configure it to use port 8070 for the Administrator Portal.

 * Oracle database server: localhost
 * SYS username/password: sys/mysyspasswd
 * ICAT username/ password: icat/myicatpasswd
 * ICATUSER username/password: icatuser/myicatuserpasswd

Java run-time:
 * java: The operating system user glassfish3 has java (1.6) on the PATH

Directories:
 * [http://code.google.com/p/icatproject/source/browse/ops/icat40/ icat40] - this contains a scripts called glassfish.sh and glassfish.props which tell the Glassfish Server what to do;
 * [http://code.google.com/p/icatproject/source/browse/ops/icat40/orainit icat40/orainit] - this contains scripts to initialise the database;
 * [http://code.google.com/p/icatproject/source/browse/ops/icat40/usertable_init icat40/usertable_init] - this contains a script to add a user to ICAT;
 * [http://code.google.com/p/icatproject/source/browse/ops/icat40/test_icat icat40/test_icat] - this contains a simple test for ICAT.

The following files are part of the ICAT 4.0 distribution:
 * [http://code.google.com/p/icatproject/source/browse/ops/icat40/icat-ear-1583-http.ear icat40/icat-ear-1583-http.ear]; 
 * [http://code.google.com/p/icatproject/source/browse/ops/icat40/icat-ear-1583.ear icat40/icat-ear-1583.ear].

Server certificate:
 * Neither the server nor a client application require a certificate, as icat-http is deployed using http protocol.

Ports:
 * The port 8070 is available for Oracle Express
 * The port 8080 is available for the Glassfish Server to deploy icat-http
 * The port 4848 is available for the the admin console of the Glassfish Server

Configuration is stored in the following files:
 * [http://code.google.com/p/icatproject/source/browse/ops/icat40/glassfish.props icat40/glassfish.props] - this contains the properties used by the glassfish.sh script;
 * [http://code.google.com/p/icatproject/source/browse/ops/icat40/passwordfile icat40/passwordfile] - this contains the password for the Glassfish Server admin console and the keystore master password;
 * [http://code.google.com/p/icatproject/source/browse/ops/icat40/usertable_init/usertable.sh icat40/usertable_init/usertable.sh] - this contains the script used to create the user icat40;
 * [http://code.google.com/p/icatproject/source/browse/ops/icat40/test_icat/example.properties icat40/test_icat/example.properties] - this contains the properties used by the test for ICAT.


== Instructions ==

Create a test environment similar to the one assumed.  If it is not possible to be identical, then the four files containing configuration may require changes.

Ensure the following conditions on the system: 

 * Database server running, and the username and passwords installed, but no content;
 * Glassfish Server installed, but not running;
 * Expand the distribution file into a directory; icat40 is used in the following instructions.

Two common errors are the following:
 * The Glassfish Server admin and keystore master passwords must agree with the value in the file passwordfile;  
 * The file ojdbc14.jar must be in the file system before the Glassfish Server is started.  If is added later, it is necessary to restart the Glassfish Server.  

Do the following:

0. Create the users called icat and icatuser in the database.  To do this, use the administrator user for the database.  This user is usually called sys:

{{{
cd icat40/orainit
sqlplus sys/mysyspasswd@localhost as sysdba @create_users.sql | tee create_users.log
cd ../..
}}}

Expect a response such as the following:

{{{
SQL*Plus: Release 10.2.0.1.0 - Production on Thu Jan 19 16:21:13 2012
Copyright (c) 1982, 2005, Oracle.  All rights reserved.
Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
Enter value for icat_password: icatpasswd
Grant succeeded.
Grant succeeded.
}}}

It will also prompt for icatuser_password.

1. Initialise the tables in the database - this will remove any existing content.

{{{
cd icat40/orainit
sqlplus icat/myicatpasswd@localhost @create_icat.sql | tee create_icat.log
cd ../..
}}}

 Expect the following outcome:

{{{
.
.
Table altered.
Table altered.
Table altered.
Table altered.
Table altered.
Table altered.
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
}}}

2. Start the Glassfish Server, create the database pools and deploy icat. Deploying icat also creates the schema for icatuser, but does not give it useful content.

 To start the Glassfish Server, do the following:

{{{
cd icat40
./glassfish.sh start
}}}

 Expect a response such as the following:

{{{
Starting database in Network Server mode on host 127.0.0.1 and port 1527.
.
.
Command start-database executed successfully.
Waiting for domain1 to start .......................................................................................................
Successfully started the domain : domain1
domain  Location: /home/glassfish3/glassfish3/glassfish/domains/domain1
Log File: /home/glassfish3/glassfish3/glassfish/domains/domain1/logs/server.log
Admin Port: 4848
Command start-domain executed successfully.
Command multimode executed successfully.
}}}

 To create the jdbc resource pools, do the following:

{{{
./glassfish.sh create
}}}

 Expect a response such as the following:

{{{
.
.
Command create-jdbc-resource executed successfully.
JDBC resource jdbc/ecat2 created successfully.
Command create-jdbc-resource executed successfully.
Command multimode executed successfully.
Ensure that Thread Pools below the configurations has an http-thread-pool with a Max Thread Pool Size of 128.
There may be more than one configuration to change. Change them all.
}}}

 To deploy icat , do the following:

{{{
./glassfish.sh deploy icat
}}}

 Expect a response such as the following:

{{{
.
.
Application deployed with name icat-ear-1583-http.
Command deploy executed successfully.
Command multimode executed successfully.
}}}

 If deploying on a system which has been previously used, expect the following response:

{{{
Application deployed successfully with name icat-ear-1583-http and with the following warning(s):

Deployment encountered SQL Exceptions:
	Got SQLException executing statement "CREATE TABLE USER_TABLE (USER_ID VARCHAR2(255) NOT NULL, PASSWORD VARCHAR2(255) NOT NULL, PRIMARY KEY (USER_ID))": java.sql.SQLException: ORA-00955: name is already used by an existing object

	Got SQLException executing statement "CREATE TABLE USER_SESSION (USER_SESSION_ID VARCHAR2(255) NOT NULL, RUN_AS VARCHAR2(255) NOT NULL, EXPIRE_DATE_TIME TIMESTAMP NOT NULL, PRIMARY KEY (USER_SESSION_ID))": java.sql.SQLException: ORA-00955: name is already used by an existing object

	Got SQLException executing statement "CREATE TABLE USER_TABLE_ANSTO (USER_ID VARCHAR2(255) NOT NULL, PASSWORD VARCHAR2(255) NOT NULL, PRIMARY KEY (USER_ID))": java.sql.SQLException: ORA-00955: name is already used by an existing object

	Got SQLException executing statement "CREATE TABLE USER_SESSION_ANSTO (USER_SESSION_ID VARCHAR2(255) NOT NULL, RUN_AS VARCHAR2(255) NOT NULL, EXPIRE_DATE_TIME TIMESTAMP NOT NULL, PRIMARY KEY (USER_SESSION_ID))": java.sql.SQLException: ORA-00955: name is already used by an existing object

Command deploy executed successfully.
Command multimode executed successfully.
}}}

Pay attention to the last part of the message.  The bit in green is only a warning and can be ignored.

3. Create a user for use by the test

{{{
cd icat40/usertable_init
./usertable.sh
cd ../..
}}}

 Expect a response such as the following:

{{{
.
.
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
SQL>   2  
1 row created.
SQL> Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
}}}

4. Run the test which does logon to the icat

{{{
cd icat40/test_icat
./test_one.sh Authenticate
cd ..
}}}

 Expect a response such as the following:

{{{
Session ID = 11af38b1-e5e9-47d2-ae41-5b23c8751997
}}}

5. If you get a response such as the above, then ICAT is working.

6. To stop icat and the Glassfish Server, do the following:
 To undeploy icat, do the following:

{{{
cd icat40
./glassfish.sh undeploy icat
}}}
 
 Expect the following outcome:

{{{
.
.
Command undeploy executed successfully.
Command multimode executed successfully.
}}}


 To delete the jdbc resource pools, do the following:

{{{
./glassfish.sh delete
}}}


 Expect the following outcome:

{{{
.
.
JDBC Connection pool icat3-user deleted successfully
Command delete-jdbc-connection-pool executed successfully.
Command multimode executed successfully.
}}}

 To stop the Glassfish Server, do the following:

{{{
./glassfish.sh stop
}}}

 Expect the following outcome:

{{{
.
.
Command stop-domain executed successfully.
2012-01-18 10:00:40.667 GMT : Connection obtained for host: 127.0.0.1, port number 1527.
2012-01-18 10:00:42.184 GMT : Apache Derby Network Server - 10.6.2.1 - (999685) shutdown
Command stop-database executed successfully.
Command multimode executed successfully.
}}}


== Dependencies ==

The following table provides the information about the distribution of configuration information among the configuration files.

|| Property          || Glassfish.props || usertable.sh || example.properties || passwordfile  || Usual Value                                               ||
|| url               || yes             || no           || no                 || no            || jdbc:oracle:thin:@//localhost:1521/XE                     ||
|| ICAT user name and password for the database - this is required for orainit also 								    ||
|| icatName          || yes             || no           || no                 || no            || ICAT                                                      ||
|| icatPW            || yes             || no           || no                 || no            || myicatpasswd                                              ||
|| ICATUSER user name and password for the database										                            ||
|| icatuserName      || yes             || yes          || no                 || no            || icatuser                                                  ||  
|| icatuserPW        || yes             || yes          || no                 || no            || myicatuserpasswd                                          ||
|| Location of the home directory for the glassfish server - this is needed for ojdbc14 and icat.properties also 				            ||
|| glassfish         || yes             || no           || no                 || no            || /home/glassfish3/glassfish3                               ||
|| connection information for glassfish server port    || yes             || no           || no                 || no            || 4848                    ||  
|| adminuser         || yes             || no           || no                 || no            || admin                                                     ||
|| passwordfile      || yes             || no           || no                 || no            || passwordfile                                              ||
|| icat file to be deployed 						                                                                                	||
|| icatear           || yes             || no           || no                 || no            || /home/glassfish3/icat40/icat-ear-1583-http.ear            ||   
|| icat file to be deployed 																																||
|| icatuser          || no              || yes          || yes                || no            || icat40                                                    ||
|| icatuserpassword  || no              || yes          || yes                || no            || icat40passwd                                              ||
|| the icat filename implies the port and the protocol and it is always localhost                                                                           ||
|| wsdl.location     || implied         || no           || yes                || no            || http://localhost:8080/ICATService/ICAT?wsdl               ||  
|| the admin password is required to logon to the glassfish 											         	||
|| admin password    || no              || no           || no                 || yes           || adminadmin                                                     ||
|| the master password is required to access the keystore 											         	||
|| master password    || no              || no           || no                 || yes           || changeit                                                    ||
|| the client file for applications to access 													         	||
|| icatclient        || no              || no           || no                 || no            || /home/glassfish3/icat40/icat-client-1583.jar              ||    


== - the end - ==