#summary Installation instructions for ICAT 4.1

<wiki:toc max_depth="3" />

= Warning - this is work in progress=

Do not rely on this documentation.  It is not yet complete.

= Installation instructions for ICAT 4.1 =

== Source of pre-requisite materials ==

Java Enterprise Edition, Glassfish Server, Oracle Database Express, the Oracle client tools (sqlplus), Oracle Java connector (ojdbc14.jar) are all available for download from Oracle.   The versions required are the following:

 * Java Enterprise Edition - 6 or newer;
 * Glassfish Server - 3.1 or newer;
 * Oracle Express - 10 or newer;
 * Oracle Client tools - 10 or newer.

== Source of installation materials ==

ICAT 4.1 is available for download from the following URL:  
{{{
http://www.icatproject.org/mvn/repo/org/icatproject/icat.ear/4.1.0-rc-03
}}}

For example, you can download with the wget commands as follows:
{{{
wget http://www.icatproject.org/mvn/repo/org/icatproject/icat.ear/4.1.0-rc-03/icat.ear-4.1.0-rc-03-config.zip 
wget http://www.icatproject.org/mvn/repo/org/icatproject/icat.ear/4.1.0-rc-03/icat.ear-4.1.0-rc-03.ear
}}}

Installation notes are available at the following URLs:
{{{
http://www.icatproject.org/mvn/site/4.1.0-rc-03/icat.ear/installation.html
http://code.google.com/p/icatproject/wiki/InstallIcat41
}}}

== Assumptions ==

In order to make it simple to install ICAT41, the following configuration is assumed:

Operating system: 
 * operation system: Linux
 * username: glassfish3
 * home directory: /home/glassfish3
 * shell: bash
 * python

Environmental variables:
It is conventional to set the following variables:
 * JAVA_HOME;
 * ORACLE_HOME;
 * ORACLE_SID;
 * GLASSFISH_HOME;
 * PATH - add $JAVA_HOME/bin, ORACLE_HOME/bin and GLASSFISH_HOME/bin. 

Note that the operating system user glassfish3 is running the Glassfish Server and the applications.  There is no need to have enhanced privileges to install ICAT once the prerequisite software has been installed and the user account glassfish3 has been created. You do not require access as system administrator of the database once the user accounts icat and icatuser have been created.

Glassfish Server:
 * directory: /home/glassfish3/glassfish3/glassfish
 * admin user: admin
 * admin user password: adminadmin
 * master password: changeit
 * asadmin command: The operating system user called glassfish3 has asadmin on the PATH 
 * ojdbc14.jar: The file ojdbc14.jar has been added to /home/glassfish3/glassfish3/glassfish/domains/domain1/lib
 * icat.properties: The file icat.properties has been added to /home/glassfish3/glassfish3/glassfish/domains/domain1/config

Oracle database:

If using Oracle Express on localhost, configure it to use port 8070 for the Administrator Portal.

 * Oracle database server: localhost
 * SYS username/password: sys/mysyspasswd
 * ICAT username/ password: icat/myicatpasswd
 * ICATUSER username/password: icatuser/myicatuserpasswd

Java run-time:
 * java: The operating system user glassfish3 has java (1.6) on the PATH

Directories:
 * [http://code.google.com/p/icatproject/source/browse/ops/icat41/                  icat41] - this contains a scripts called glassfish.sh and glassfish.props which tell the Glassfish Server what to do;
 * [http://code.google.com/p/icatproject/source/browse/ops/icat41/orainit           icat41/orainit] - this contains scripts to initialise the database;
 * [http://code.google.com/p/icatproject/source/browse/ops/icat41/usertable_init    icat41/usertable_init] - this contains a script to add a user to ICAT;
 * [http://code.google.com/p/icatproject/source/browse/ops/icat41/test_icat         icat41/test_icat] - this contains a simple test for ICAT.

The following files are part of the ICAT 4.1 distribution:
 * [http://code.google.com/p/icatproject/source/browse/ops/icat41/icat-ear-1583-http.ear      icat41/icat-ear-1583-http.ear]; 
 * [http://code.google.com/p/icatproject/source/browse/ops/icat41/icat-ear-1583.ear           icat41/icat-ear-1583.ear].

Server certificate:
 * Neither the server nor a client application require a certificate, as icat-http is deployed using http protocol.

Ports:
 * The port 8070 is available for Oracle Express
 * The port 8080 is available for the Glassfish Server to deploy icat-http
 * The port 4848 is available for the the admin console of the Glassfish Server

Configuration is stored in the following files:
 * [http://code.google.com/p/icatproject/source/browse/ops/icat41/glassfish.props                  icat41/glassfish.props] - this contains the properties used by the glassfish.sh script;


== Instructions ==

Create a test environment similar to the one assumed.  If it is not possible to be identical, then the four files containing configuration may require changes.

Ensure the following conditions on the system: 

 * Database server running, and the username and passwords installed, but no content;
 * Glassfish Server installed, but not running;
 * Expand the distribution file into a directory; icat41 is used in the following instructions.

Two common errors are the following:
 * The icat properties file must be in the config directory of the glassfish server.  
 * The file ojdbc14.jar must be in the file system before the Glassfish Server is started.  If is added later, it is necessary to restart the Glassfish Server.  

Do the following:

1. Start the Glassfish Server, create the database pools and deploy icat. Deploying icat also creates the schemas for icat and icatuser, but does not give them useful content.

To start the Glassfish Server, do the following:

{{{
cd icat41
asadmin start-domain domain1
}}}

Expect a response such as the following:

{{{
Waiting for domain1 to start .......................................................................................................
Successfully started the domain : domain1
domain  Location: /home/glassfish3/glassfish3/glassfish/domains/domain1
Log File: /home/glassfish3/glassfish3/glassfish/domains/domain1/logs/server.log
Admin Port: 4848
Command start-domain executed successfully.
}}}

To create the jdbc and jms resources, do the following:

{{{
./create.sh
}}}

Expect a response such as the following:

{{{
.
.
server.http-service.access-log.format=common
Command set executed successfully.
server.http-service.access-logging-enabled=true
Command set executed successfully.
JDBC connection pool icat created successfully.
Attempting to ping during JDBC Connection Pool Creation : icat - Succeeded.
.
.
.
Command create-jms-resource executed successfully.
Administered object jms/ICATTopic created.
Command create-jms-resource executed successfully.
}}}

To deploy icat , do the following:

{{{
asadmin deploy icat.ear-4.1.0-rc-03.ear
}}}

Expect a response such as the following:

{{{
Application deployed with name icat.ear-4.1.0-rc-03.
Command deploy executed successfully.
}}}

If deploying on a system which has been previously used, expect the following response:

{{{
Cannot create tables for application icat.ear-4.1.0-rc-03. The expected DDL file icat.ear-4.1.0-rc-03_icat.exposed-4.1.0-rc-03_icatuser_createDDL.jdbc is not available.
PER01003: Deployment encountered SQL Exceptions:
	PER01000: Got SQLException executing statement "CREATE TABLE PUBLICATION (ID NUMBER(19) NOT NULL, CREATE_ID VARCHAR2(255) NOT NULL, CREATE_TIME TIMESTAMP NOT NULL, FULLREFERENCE VARCHAR2(255) NOT NULL, MOD_ID VARCHAR2(255) NOT NULL, MOD_TIME TIMESTAMP NOT NULL, REPOSITORY VARCHAR2(255) NULL, REPOSITORYID VARCHAR2(255) NULL, URL VARCHAR2(255) NULL, INVESTIGATION_ID NUMBER(19) NOT NULL, PRIMARY KEY (ID))": java.sql.SQLException: ORA-00955: name is already used by an existing object
.
.
Command deploy executed successfully.
}}}

Pay attention to the last line of the message.  The bit in green is only a warning and can be ignored.


4. Run the test which does logon to the icat

{{{
cd icat41/test_icat
python test.py 8181 password
cd ..
}}}

Expect a response such as the following:

{{{
It seems to work...
}}}

5. If you get a response such as the above, then ICAT is working.

6. To stop icat and the Glassfish Server, do the following:
 To undeploy icat, do the following:

{{{
cd icat41
asadmin undeploy icat.ear-4.1.0-rc-03
}}}
 
Expect the following outcome:

{{{
Command undeploy executed successfully.
}}}

To delete the jdbc and jms resources, do the following:

{{{
./drop.sh
}}}

Expect the following outcome:

{{{
.
.
JDBC Connection pool icat3-user deleted successfully
Command delete-jdbc-connection-pool executed successfully.
}}}

To stop the Glassfish Server, do the following:

{{{
asadmin stop-domain domain1
}}}

Expect the following outcome:

{{{
Command stop-domain executed successfully.
}}}


== - the end - ==