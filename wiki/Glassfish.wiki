#summary How to install and configure Glassfish.

= Introduction =

This page is here for convenience though it is nothing to do with ICAT.


= Details =

== JDK ==

Get the latest stable jdk for your architecture from the Oracle web site. It is known as Java SE and you want the JDK download. 
* You must use at least JDK 1.7 *

Openjdk has exhibited some problems with glassfish so it is preferable to use the Oracle build.

jdk-7u25-linux-x64.rpm is known to work on `RedHat/CentOS/SL` machines. You need to ensure that it is in the PATH of the person running glassfish. This can be done by adding `/usr/java/jdk1.7.0_??/bin/` to the beginning of the PATH for that user (ahead of /usr/bin if openjdk is also installed) or use the alternatives command to specify that this is your preferred java. You should ensure that java, javac, jps, keytool etc are all available from the Oracle distribution.

=== Glassfish ===

Designate an account for running glassfish. I will call this the glassfish account though the user name does not have to be glassfish.

For glassfish3 get the latest glassfish3 zip file and unzip it to, for example, the  home directory of the glassfish account. Add ~/glassfish3/glassfish/bin to the path of the user. ogs-3.1.2.2.zip is known to work.

For glassfish4 get the latest distribution without jdk. Testing has been carried out with glassfish-4.0.zip. Install with the defaults. You may prefer not to install the updatetool. Add ~/glassfish4/glassfish/bin to the path of the user. * However ICAT4.3.0 will not install under glassfish4 *

Ensure that hostname -f returns a sensible result. Then issue the following commands. When you create the domain you will be asked to specify the admin username and password. Do not use the default empty password.

{{{
asadmin delete-domain domain1
asadmin create-domain domain1
asadmin start-domain
asadmin enable-secure-admin
asadmin stop-domain
asadmin start-domain
asadmin login
asadmin set server.http-service.access-log.format="common"
asadmin set server.http-service.access-logging-enabled=true
asadmin set server.thread-pools.thread-pool.http-thread-pool.max-thread-pool-size=128
asadmin delete-ssl --type http-listener http-listener-2
asadmin delete-network-listener http-listener-2
asadmin create-network-listener --listenerport 8181 --protocol http-listener-2 http-listener-2
asadmin create-ssl --type http-listener --certname s1as --ssl3enabled=false --ssl3tlsciphers +SSL_RSA_WITH_RC4_128_MD5,+SSL_RSA_WITH_RC4_128_SHA http-listener-2
}}}

If you wish, go to http://localhost:4848 you will be redirected to https and will be able to login as admin to see from the GUI how the server is configured.

=== Firewalls ===
Depending upon your installation it is possible that the ports normally used by glassfish (4848 and 8181) are blocked. If this is the case allow the ports to be used. How you do this is platform dependent.

=== Certificates ===
If you don't have a trusted certificate then any java application seeking to use the glassfish will need to be told to trust it. Go to the config directory for your domain and:
{{{
keytool -export -keystore keystore.jks -file cert -storepass changeit -alias s1as
}}}
will extract the certificate to a file called cert. The keystore password is by default "changeit". Then go to the jre/lib/security directory for the jdk you will use and if jssecacerts does not exist:
{{{
cp cacerts jssecacerts
}}}
which leaves the original cacerts unchanged. However jssecacerts will be used in preference to cacerts. Then:
{{{
keytool -import -keystore jssecacerts -file <cert> -storepass changeit -alias <full host name> -noprompt
}}}
where {{{<cert>}}} identifies the exported certificate and the recommended alias is the fully qualified name of the machine you are trusting.

=== Expired certificates ===
Expired cacerts appear to do not harm except for cluttering the server.log. To get rid of them go to the config directory for your domain and:
{{{
keytool -delete -keystore cacerts.jks -alias gtecybertrustglobalca -storepass changeit
keytool -delete -keystore cacerts.jks -alias gtecybertrust5ca -storepass changeit
}}}
for each offending certificate. The keystore password is by default "changeit".


=== Database connectors ===
Your chosen database jars must be installed in the lib directory of your domain. These files will have names such as: mysql-connector-java-5.1.21-bin.jar (for MySQL) and ojdbc6.jar (for Oracle). After installing these jars glassfish must be restarted. It is recommended to use asadmin stop-domain followed by asadmin start-domain to achieve this.

=== Problems starting glassfish ===
In some circumstances glassfish may refuse to start. A series of dots will appear on the screen and after about four rows will time out. To get round this problem:
 * determine which is the bad component by looking at the end of the server.log to see what it is was trying to load
 * edit domain.xml in the config directory - find the line in the section 
{{{
  <servers>
    <server>
}}}
starting with  <application-ref ref="... for the troublesome component and disable it it by inserting "enabled="false" so that the line now starts:  <application-ref "enabled="false" ref="...
 * start the domain with asadmin start-domain ...
 * enable the component with asadmin enable ...

To avoid the problem if you need to stop and start the domain, disable the troublesome component before stopping it and enable it after starting the domain.