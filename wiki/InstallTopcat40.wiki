#summary Installation instructions for TOPCAT with ICAT4.0

<wiki:toc max_depth="3" />

= Installing Topcat for use with ICAT40 =

Topcat is a companion product for Icat.  It provides a user friendly way to browse the contents of one or more instances of Icat.  

These installation instructions are intended for installing Topcat as a companion to Icat40.

== Source of installation materials ==

Topcat for ICAT 4.0 is available for download from the following URL:  
{{{
http://icatproject.googlecode.com/svn/ops/topcat40 
}}}

For example, you can download with the wget command as follows:
{{{
wget --recursive --no-parent http://icatproject.googlecode.com/svn/ops/topcat40
}}}

Note that if using the wget command, the materials will be downloaded to the following directory:
{{{
icatproject.googlecode.com/svn/ops/topcat40
}}}

If you would like a version from the SVN, then it can be obtained with a command as follows:
{{{
svn checkout https://icatproject.googlecode.com/svn/ops/topcat40 
}}}

If you wish to browse the materials on the web site, use the following link:
{{{
http://code.google.com/p/icatproject/source/browse/ops/topcat40/
}}}

== Files in the installation materials ==

Note that the dates, times and file sizes may differ from those shown in these notes.

The following file provides a short set of instructions for installation:
{{{
-rw-rw-r-- 1 glassfish3 glassfish3     2960 Apr  4 18:05 readme.txt
}}}

The following script and its props file provide an easy way to configure the database and deploy the application:
{{{
-rwxrwxr-x 1 glassfish3 glassfish3     8037 Apr  4 18:05 deploy.sh
-rwxrwxr-x 1 glassfish3 glassfish3      574 Apr  4 18:08 deploy.props.example
}}}

The following files are invoked from deploy.sh using the sqlplus command; they perform operations on the database to prepare it for Topcat:
{{{
-rw-rw-r-- 1 glassfish3 glassfish3     1573 Apr  3 13:46 createuser_topcat_db.sql
-rw-rw-r-- 1 glassfish3 glassfish3     3025 Apr  3 13:46 generate_topcat_db.sql
-rw-rw-r-- 1 glassfish3 glassfish3      235 Apr  4 16:10 initialise_topcat_db.sql
}}}

The following files contain the connection information for three ICATs which can be connected to Topcat.  The list file is a list of which .icat files to use:
{{{
-rw-rw-r-- 1 glassfish3 glassfish3       43 Apr  4 18:05 icat.list
-rwxrwxr-x 1 glassfish3 glassfish3      147 Apr  4 18:05 icata.icat
-rwxrwxr-x 1 glassfish3 glassfish3      147 Apr  4 18:05 icatb.icat
-rwxrwxr-x 1 glassfish3 glassfish3      143 Apr  4 18:07 localhost.icat
}}}

The following files contain the TopCAT web application in compiled form, and its properties file; the properties file has to be made available to the Glassfish server.
{{{
-rw-rw-r-- 1 glassfish3 glassfish3      469 Apr  3 13:46 topcat.properties.example
-rw-rw-r-- 1 glassfish3 glassfish3 28180800 Apr  3 13:46 TopCAT-0145.war
}}}

== Description ==

The installation procedure deals with the following requirements:

 - the files for the glassfish server must contain a properties file which tells Topcat some simple things about its appearance;

 - the glassfish server has to have connection pools created for use by Topcat;

 - two database schemas have to be created called topcat and download for use by the topcat and download applications;

 - the topcat database schema has to be populated with information about the location of the ICATs which it has to service;

 - the topcat application has to be deployed on the Glassfish server.
 
When configuring the ICATs to be serviced, there are the following files:
{{{
topcat40/icat.list
topcat40/localhost.icat
topcat40/icata.icat
topcat40/icatb.icat
}}}
 
The file called icat.list contains a list of files, one file per line, and each file contains the connection information for one icat.  If you require a different collection of ICATs, you have to edit icat.list and perhaps create new .icat files.  The examples icata.icat and icatb.icat are demonstration ICATs on the public server www.icatproject.org.

If you are operating behind a firewall, it may be necessary to make changes to the glassfish server so that it can deal with ICATs which are outside of the firewall, or to allow clients from outside the firewall to use an ICAT within.  This can be done either through the glassfish admin console or through asadmin with the following commands:

asadmin create-jvm-options "-Dhttp.proxyHost=myproxy.mydomain"

asadmin create-jvm-options "-Dhttp.proxyPort=myproxy.port"


=== Installation of icat40 ===

The location of an installation of Icat40 relative to the location of the topcat40 directory:
{{{
../icat40 - installed and accessible in the specified directory. The location of icat40 can be changed in the deploy.props.
}}}

=== Available port ===

Port 8181 is available for the Glassfish Server to deploy Topcat.

=== Glassfish server ===

Ensure that the topcat.properties is available in:
{{{
/home/glassfish3/glassfish3/glassfish/domains/domain1/lib/classes 
}}}

== Configuration files ==

Configuration is stored in the following files:
{{{
topcat40/deploy.props
topcat40/topcat.properties
topcat40/icat.list
topcat40/localhost.icat
topcat40/icata.icat
topcat40/icatb.icat
}}}

== Instructions ==

Create a test environment similar to the one assumed in these instructions in addition to the one for ICAT40.  If it is not possible to be identical, then deploy.props may require changes. 

Ensure the following conditions on the system: 

 - database server running;

 - glassfish server running with the ICAT deployed and operational;

 - the file topcat.properties is available in the appropriate directory for the glassfish server (see above).

Do the following:

=== Add information to the database for Topcat ===

Configure that database with the information which is required by Topcat:
{{{
# Create schemas, initialise the tables and add ICAT information.  
cd topcat40
./deploy.sh setupDB
cd ..
}}}

Expect a response such as the following:

{{{
SQL*Plus: Release 11.2.0.2.0 Production on Thu Apr 5 11:38:27 2012
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
SQL> 
User created.
SQL> 
User created.
SQL> 
====================================================================
creating user topcat
Grant succeeded.
.
.
.
1 row created.
1 row created.
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
}}}

=== Create connection pools for Topcat on Glassfish ===

Configure the glassfish server to have the connection pools required by Topcat:
{{{
# Create the database pools
cd topcat40
./deploy.sh create
cd ..
}}}

Expect the following response:
{{{
Use "exit" to exit and "help" for online help.
JDBC connection pool TopCATDB created successfully.
Command create-jdbc-connection-pool executed successfully.
JDBC resource jdbc/TopCATDB created successfully.
Command create-jdbc-resource executed successfully.
JDBC connection pool downloadmanager__pm created successfully.
Command create-jdbc-connection-pool executed successfully.
JDBC resource jdbc/downloadmanager__pm created successfully.
Command create-jdbc-resource executed successfully.
JDBC connection pool downloadmanager__nontx created successfully.
Command create-jdbc-connection-pool executed successfully.
JDBC resource jdbc/downloadmanager__nontx created successfully.
Command create-jdbc-resource executed successfully.
Command multimode executed successfully.
}}}

===  Configure Topcat to accept the list of ICATs ===

Tell Topcat which ICATs to use:

{{{
# Deploy topcat
cd topcat40
./deploy.sh setupICAT
cd ..
}}}

Expect a response such as the following:
{{{
SQL*Plus: Release 11.2.0.2.0 Production on Thu Apr 5 11:48:26 2012
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to: Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
SQL> 1 row created.
SQL> Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
SQL*Plus: Release 11.2.0.2.0 Production on Thu Apr 5 11:48:26 2012
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
SQL> 1 row created.
SQL> Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
SQL*Plus: Release 11.2.0.2.0 Production on Thu Apr 5 11:48:26 2012
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
SQL> 1 row created.
SQL> Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
}}}

=== Deploy topcat on Glassfish ===

Deploy topcat on the glassfish server:
{{{
# Deploy topcat
cd topcat40
./deploy.sh deploy topcat
cd ..
}}}

Expect a response such as the following:
{{{
Use "exit" to exit and "help" for online help.
Application deployed with name TopCAT.
Command deploy executed successfully.
Command multimode executed successfully.
}}}

=== Verify that Topcat is available  ===

Enter the following into a browser in order to run Topcat:
{{{
# Logon to topcat 
https://localhost:8181/TOPCATWeb.jsp 
}}}

You may get a warning of the form "This Connection is Untrusted".  You should tell the browser to proceed.  Topcat should display its welcome page and invite you to login.

=== Closing down Topcat  ===

To undeploy topcat and delete the connection pools, do the following:
{{{
cd topcat40
./deploy.sh undeploy topcat
./deploy.sh delete
cd ..
}}}

=== Changing the configuration of the Topcat ===

If you wish to change the configuration of the Topcat once it has been started, it is necessary undeploy the Topcat and remove the Topcat connections in the glassfish server while doing this.  The reason is that the database will not permit the removal of tables which are in use, and once the glassfish server has establised the connection pools, the tables in the database are in use.  

To make changes to the Topcat configuration once it is running, do the following:
{{{
cd topcat40
./deploy.sh undeploy topcat
./deploy.sh delete
./deploy.sh deleteICAT
./deploy.sh deleteDB

# The database is now ready for redefinition

./deploy.sh setupDB
./deploy.sh setupICAT
./deploy.sh create
./deploy.sh deploy topcat

cd ..
}}}

=== Account locking in the database ===

When making changes to the Topcat configuration, you may find that Database locks the Topcat account. You may see a message such as the following: 
{{{
*** Deploying topcat
./deploy.sh deploy /home/glassfish3/topcat40/TopCAT.war
Use "exit" to exit and "help" for online help.
remote failure: Error occurred during deployment: Exception while preparing the app : Exception [EclipseLink-4002] (Eclipse Persistence Services - 2.3.2.v20111125-r10461): org.eclipse.persistence.exceptions.DatabaseException
Internal Exception: java.sql.SQLException: Error in allocating a connection. Cause: Connection could not be allocated because: ORA-28000: the account is locked
Error Code: 0. Please see server.log for more details.
Command deploy failed.
Command multimode failed.
}}}

This message does not indicate which account is locked, but it is probably the Topcat account.  If using Oracle Express, the APEX interface provides a simple tool to unlock the account.  

=== Monitoring the actions of the Topcat application ===

During installation of Topcat, it is useful to watch the server log file.  This can be  done with a command such as the following in a terminal window to the server:

{{{
tail -f /home/glassfish3/glassfish3/glassfish/domains/domain1/logs/server.log
}}}

=== Starting and stopping the glassfish server ===

There are further options available in icat40/glassfish.sh.  For example, to start and stop the glassfish server, use icat40/glassfish.sh.

=== Summary of options available in deploy.sh ===

The script deploy.sh supports the following arguments:

|| Value               || Meaning                                                                                                                                            ||
|| setupDB             || Creates and populates the database schemas for Topcat                                                                                              || 
|| setupICAT           || Populates the database schemas for Topcat with information about the available ICATs                                                               || 
|| deleteDB            || Complement of setupDB                                                                                                                              || 
|| deleteICAT          || Complement of setupICAT                                                                                                                            || 
|| create              || Creates the jdbc connection pools between the database and glassfish. Please ensure that the parameters in deploy.props are correctly defined.     || 
|| delete              || Deletes the jdbc connection pool between the database and glassfish.                                                                               || 
|| deploy topcat       || Deploys topcat                                                                                                                                     || 
|| undeploy topcat     || Undeploys topcat                                                                                                                                   || 

== - the end - ==